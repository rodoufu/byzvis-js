<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ByzVis</title>
    <script type="text/javascript" src="js/d3.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
</head>
<body>
<div class="container">
    <div id="byzvis" class="container">
    </div>
    <div class="container fixed-bottom">
        <div class="mb-3 row">
            <div class="col-sm-2">
                <button type="button" id="playPause" class="btn btn-primary">Play</button>
            </div>
            <div class="col-sm-10">
                <label for="timeRange" class="form-label">Time range</label>
                <input type="range" class="form-range" id="timeRange">
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
	"use strict";

	class Message {
		constructor(moment, source, target, status) {
			this.moment = parseInt(moment);
			this.source = parseInt(source);
			this.target = parseInt(target);
			this.status = parseInt(status);
		}

		isUnexpected() {
			return this.status === 0;
		}

		isSuccess() {
			return this.status === 1;
		}

		isNotDelivered() {
			return this.status === 2;
		}

		isTampered() {
			return this.status === 3;
		}
	}

	class General {
		constructor(id, x, y) {
			id = parseInt(id);
			this.id = `G${id}`;
			this.x = x;
			this.y = y;
		}

		draw(body) {
			body.append("svg").attr("width", 50).attr("height", 50).attr('class', `general ${this.id}`)
				.append('circle')
				.attr('cx', 25)
				.attr('cy', 25)
				.attr('r', 20)
				.attr('stroke', 'black')
				.attr('fill', '#578430');
			$(`svg.${this.id}`).css({top: this.y, left: this.x, position: 'absolute'});
		}

		async sendMessage(body, target, message, duration) {
			let msgId = `${this.id}to${target.id}`;
			let msg = body.append("svg").attr("width", 50).attr("height", 50).attr('class', `message ${msgId}`);
			let rect = msg.append("rect")
				.attr('x', 15)
				.attr('y', 15)
				.attr('width', 20)
				.attr('height', 20)
				.attr('stroke', 'black')
				.attr('fill', '#69c2ef');
			$(`svg.${msgId}`).css({top: this.y, left: this.x, position: 'absolute'});

			let transition = msg.transition()
				.attr("style", `top: ${target.y}px; left: ${target.x}px; position: absolute;`);
			if (message.isNotDelivered()) {
				transition = transition.attr('opacity', 0.5);
			} else if (message.isTampered()) {
				rect.transition().attr('fill', '#e8b510').duration(duration);
			}
			await transition.duration(duration).end();
			msg.transition().remove();
		}
	}

	class ByzantineVisualization {
		constructor(data, width, height, timeSlot) {
			this.numberOfGenerals = 0;
			this.maxTime = 0;

			this.timeMessage = new Map();
			for (let i = 0; i < data.length; i++) {
				const message = new Message(data[i].moment, data[i].source, data[i].target, data[i].status);
				let messages = [];
				if (this.timeMessage.has(message.moment)) {
					messages = this.timeMessage.get(message.moment);
				}
				messages.push(message);
				this.timeMessage.set(message.moment, messages);

				if (this.numberOfGenerals < message.source) {
					this.numberOfGenerals = message.source;
				}
				if (this.numberOfGenerals < message.target) {
					this.numberOfGenerals = message.target;
				}
				if (this.maxTime < message.moment) {
					this.maxTime = message.moment;
				}
			}
			this.numberOfGenerals++;
			this.maxTime++;

			this.generals = [];
			const radius = 15 * this.numberOfGenerals;
			for (let i = 0; i < this.numberOfGenerals; i++) {
				let general = new General(i,
					Math.round(width / 2 + radius * Math.cos(i * 2 * Math.PI / this.numberOfGenerals)),
					Math.round(height / 2 + radius * Math.sin(i * 2 * Math.PI / this.numberOfGenerals))
				);
				this.generals.push(general);
			}

			this.timeSlot = timeSlot;
			if (!this.timeSlot) {
				this.timeSlot = 1000;
			}
			this.current = 0;
			this.interval = null;
		}

		draw(body) {
			body.append("p").text(`${this.numberOfGenerals} generals, and ${this.maxTime} time slots`);
			for (let general of this.generals) {
				general.draw(body);
			}
		}

		start(body) {
			if (!this.interval) {
				this.interval = setInterval(() => {
					if (this.timeMessage.has(this.current)) {
						let messages = this.timeMessage.get(this.current);
						for (let message of messages) {
							const source = this.generals[message.source];
							const target = this.generals[message.target];

							source.sendMessage(body, target, message, this.timeSlot);
						}
					}
					if (this.current === this.maxTime) {
						console.log("Finished");
						this.stop();
						this.current = 0;
					}
					this.current++;
				}, this.timeSlot);
			}
		}

		stop() {
			if (this.interval) {
				clearInterval(this.interval);
				this.interval = null;
			}
		}

		isRunning() {
			return this.interval;
		}
	}

	$(document).ready(() => {
		let byzVis = null;
		d3.csv('problems/larger.csv').then((data) => {
			let body = d3.select("body div#byzvis");
			const width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
			const height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;

			byzVis = new ByzantineVisualization(data, width, height, 1000);
			byzVis.draw(body);
		});

		$("#playPause").click(() => {
			if (byzVis) {
				let body = d3.select("body div#byzvis");
				if (byzVis.isRunning()) {
					byzVis.stop();
				} else {
					byzVis.start(body);
				}
			}
		});
	});
</script>
</body>
</html>